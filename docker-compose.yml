version: "3.8"

services:
  # ===============================================
  # 1. NODO SPARK MASTER (Driver)
  # ===============================================
  spark-master:
    image: jupyter/pyspark-notebook:latest
    container_name: spark-master
    hostname: spark-master
    user: root
    command: >
      bash -c "
        /usr/local/spark/sbin/start-master.sh &&
        tail -f /dev/null
      "
    stdin_open: true
    tty: true
    environment:
      SPARK_MASTER_PORT: 7077
      SPARK_DRIVER_HOST: spark-master
      SPARK_DRIVER_PORT: 9000
      SPARK_LOCAL_IP: spark-master
    ports:
      - "8080:8080"
      - "7077:7077"
    volumes:
      - ./data:/opt/spark-data
      - ./src:/opt/spark-code
    networks:
      - spark-net

  # ===============================================
  # 2. NODO SPARK WORKER (escalar con --scale)
  # ===============================================
  spark-worker:
    image: jupyter/pyspark-notebook:latest
    hostname: spark-worker
    user: root
    command: >
      bash -c "
        /usr/local/spark/sbin/start-worker.sh spark://spark-master:7077 &&
        tail -f /dev/null
      "
    stdin_open: true
    tty: true
    environment:
      SPARK_WORKER_CORES: ${SPARK_WORKER_CORES:-1}
      SPARK_WORKER_MEMORY: ${SPARK_WORKER_MEMORY:-1g}
    volumes:
      - ./data:/opt/spark-data
    networks:
      - spark-net
    depends_on:
      - spark-master
    restart: always

networks:
  spark-net:
    driver: bridge
